# Dúvida 3 — Infra (Next.js BFF + Python API)

_Data: 17/11/2025_

## TL;DR
- Dois serviços em Cloud Run: `bff-front` (Next.js) público, `core-api` (FastAPI) privado com VPC Connector.
- Cloud Load Balancing + Cloud CDN na frente do `bff-front`; API recebe tráfego apenas do BFF (mTLS ou Auth header assinado) e dos webhooks necessários.
- Banco (Cloud SQL Postgres) e Redis (MemoryStore) continuam compartilhados e gerenciados pelo backend Python; o BFF fala com eles só por meio da API.
- Custos sobem ~25‑35 % vs arranjo único porque você duplica Cloud Run, CDN e monitoração, mas ganha isolamento e facilita futuras features de SSR/edge.

## Componentes
- **Next.js BFF (`bff-front`)**: Cloud Run mínimo 0, máx 2‑4 instâncias, Build com `gcloud builds submit`. Expõe rotas `/api/*` para auth/OAuth, proxies e serve React (RSC/SSR) e assets estáticos já com CDN.
- **FastAPI Core (`core-api`)**: Cloud Run sem tráfego público. Requer Serverless VPC Connector para alcançar Cloud SQL, Redis, Z-API etc. Recebe chamadas apenas via Cloud Load Balancer interno ou IAP service account do BFF.
- **Cloud SQL + MemoryStore**: a mesma instância atual. Next não toca neles diretamente; o BFF faz requisições HTTP/gRPC para o FastAPI, que segue dono do schema.
- **Ingressos externos**: webhooks (WhatsApp, CRMs) continuam indo direto ao FastAPI via endpoint público separado ou Pub/Sub push.

## Rede e Domínios
- `app.pilotodevendas.com.br` → Load Balancer (HTTP/2) → Cloud Run `bff-front` → API privada.
- `api.pilotodevendas.com.br` pode continuar apontando para FastAPI para integrações de terceiros; use política `Require JWT`/mTLS para clientes internos.
- Configurar Cloud CDN + Cloud Armor no LB para amortizar latência global e bloquear tráfego malicioso antes de chegar ao BFF.

## Segurança e Auth
- Sessão continua centralizada ao FastAPI. O Next.js guarda somente cookies e chama endpoints `/session/*` para criar/invalidar.
- Comunicação BFF→API usa Service Account + `Authorization: Bearer <signed>` ou assinatura via Google Service-to-Service; evita exposição do API token ao navegador.
- Secret Manager armazena OAuth client secrets e credenciais de provedores; ambos os serviços acessam via IAM, com privilégios mínimos.

## Custos e Operação
- Cloud Run (2 serviços) + Load Balancer + CDN + VPC Connector somam ~US$90‑140/mês nos limites típicos (até 2 vCPU, 1 GB, 1 instância média rodando). Acrescente Logging/Monitoring (Cloud Logging, Error Reporting) para cada serviço.
- Terraform separa módulos (`cloud_run_bff`, `cloud_run_api`, `lb`) e pipelines distintos. Observabilidade duplica (dois dashboards, dois alarmes de latência/erros).

## Quando vale
- Use esta infra se precisar de SSR/streaming, NextAuth, Edge Middleware, personalização por request antes de chamar o backend ou se planeja liberar funcionalidades web rapidamente sem tocar no core Python.
- Para o MVP focado em dashboard e pouca lógica server-side, o custo extra e a operação duplicada podem não compensar; dê o salto apenas quando os benefícios acima forem claros.
