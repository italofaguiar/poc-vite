# Infra: NextJS BFF + Python API (Cen√°rio Separado)

**Data:** 16/11/2025
**Contexto:** Cen√°rio com BFF NextJS p√∫blico + API Python privada
**Stack:** 2 CloudRun separados na GCP

---

## a) 2 CloudRun (1 API, 1 BFF+Front)?

### Sim, a arquitetura seria:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          Internet (HTTPS)                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  Cloud Load Balancer ‚îÇ (Opcional, mas recomendado)
                    ‚îÇ   (HTTPS/SSL Term)   ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   CloudRun: BFF      ‚îÇ  üåê P√öBLICO
                    ‚îÇ   (NextJS)           ‚îÇ
                    ‚îÇ   - SSR Frontend     ‚îÇ
                    ‚îÇ   - API Routes       ‚îÇ
                    ‚îÇ   - OAuth2 handlers  ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  VPC Connector       ‚îÇ  üîê Comunica√ß√£o Privada
                    ‚îÇ  (Serverless VPC)    ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   CloudRun: API      ‚îÇ  üîí PRIVADO
                    ‚îÇ   (Python/FastAPI)   ‚îÇ  (sem ingress p√∫blico)
                    ‚îÇ   - Business Logic   ‚îÇ
                    ‚îÇ   - LLM/RAG          ‚îÇ
                    ‚îÇ   - DB Access        ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   CloudSQL           ‚îÇ  üîí PRIVADO
                    ‚îÇ   (Postgres)         ‚îÇ  (Private IP)
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Componentes:

**1. CloudRun BFF (NextJS) - P√öBLICO**
- **Ingress:** Allow all (p√∫blico na internet)
- **Fun√ß√£o:**
  - Servir frontend (SSR/SSG)
  - API routes (`/api/*`)
  - Gerenciar OAuth2 (se for essa a escolha)
  - Proxy requests para API Python
- **Dom√≠nio:** `app.pilotodevendas.com.br`

**2. CloudRun API (Python) - PRIVADO**
- **Ingress:** Internal only (s√≥ recebe de dentro da VPC)
- **Fun√ß√£o:**
  - Business logic
  - LLM/RAG (Langchain)
  - Acesso direto ao Postgres
  - WhatsApp handlers
- **Acesso:** Via VPC Connector do BFF
- **URL interna:** `https://api-xyz.a.run.app` (n√£o acess√≠vel publicamente)

**3. VPC Connector (Serverless)**
- Ponte entre BFF (p√∫blico) ‚Üí API (privada)
- Regi√£o: mesma dos CloudRun
- Throughput: 200-300 Mbps (tier inicial)

**4. CloudSQL (Postgres) - PRIVADO**
- Private IP apenas
- Acessado por: API Python
- BFF **N√ÉO** acessa diretamente (boa pr√°tica)

---

## b) Precisaria de Load Balancer?

### Resposta: **Tecnicamente n√£o √© obrigat√≥rio, mas RECOMENDADO**

### Cen√°rio 1: SEM Load Balancer (mais simples)

**Setup:**
```
Browser ‚Üí CloudRun BFF (p√∫blico) ‚Üí VPC ‚Üí CloudRun API (privado)
```

**CloudRun BFF:**
- URL direta do CloudRun: `https://bff-abc123.a.run.app`
- Mapeia custom domain: `app.pilotodevendas.com.br`
- SSL autom√°tico do CloudRun

**Vantagens:**
- ‚úÖ Mais simples
- ‚úÖ Sem custo de Load Balancer
- ‚úÖ SSL gerenciado automaticamente
- ‚úÖ Bom para MVP

**Desvantagens:**
- ‚ùå Menos flexibilidade futura
- ‚ùå Sem WAF (Web Application Firewall)
- ‚ùå Sem Cloud Armor (DDoS protection)
- ‚ùå Sem CDN integrado

**Custo:**
- $0 (infraestrutura)

### Cen√°rio 2: COM Load Balancer (recomendado para produ√ß√£o)

**Setup:**
```
Browser ‚Üí Load Balancer ‚Üí CloudRun BFF ‚Üí VPC ‚Üí CloudRun API
```

**GCLB (Google Cloud Load Balancer):**
- HTTPS Load Balancer (Layer 7)
- SSL termination
- Backend: CloudRun BFF (serverless NEG)

**Vantagens:**
- ‚úÖ Cloud Armor (prote√ß√£o DDoS, rate limiting, IP blocking)
- ‚úÖ Cloud CDN (cache est√°tico no edge)
- ‚úÖ URL routing avan√ßado (exemplo abaixo)
- ‚úÖ Melhor para produ√ß√£o
- ‚úÖ SSL gerenciado do Google
- ‚úÖ M√©tricas unificadas

**Exemplo de routing:**
```yaml
# URL map do Load Balancer
/api/*     ‚Üí CloudRun BFF (pode at√© rotear direto pra Python no futuro)
/assets/*  ‚Üí Cloud Storage (est√°ticos) com CDN
/*         ‚Üí CloudRun BFF (NextJS SSR)
```

**Desvantagens:**
- ‚ùå Mais complexo (mas n√£o muito)
- ‚ùå Custo adicional

**Custo:**
- ~$18-25/m√™s base (forwarding rules)
- ~$0.008 por GB processado
- Cloud CDN: ~$0.02-0.08 por GB (se habilitar)

### Recomenda√ß√£o:

**MVP (2 meses):** Comece **SEM** Load Balancer
- Use URL direta do CloudRun com custom domain
- Ative depois quando tiver tr√°fego

**Produ√ß√£o (3-6 meses):** Migre para Load Balancer
- Cloud Armor para seguran√ßa
- CDN para assets est√°ticos
- Preparado para escalar

---

## c) Custo detalhado

### Componentes e Custos Mensais (Estimativa)

#### 1. CloudRun BFF (NextJS)

**Specs iniciais:**
- CPU: 1 vCPU
- RAM: 512MB
- Instances: 0-10 (autoscale)
- Concurrency: 80

**Cen√°rio conservador (100 usu√°rios ativos/dia):**
- Requests: ~300k/m√™s
- CPU time: ~50h/m√™s
- RAM: ~25 GB-hours/m√™s

**Custo:**
- CPU: 50h √ó $0.00002400/vCPU-sec = ~$4.32
- RAM: 25 GB-h √ó $0.00000250/GB-sec = ~$0.22
- Requests: 300k √ó $0.40/milh√£o = ~$0.12
- **Total: ~$5/m√™s**

#### 2. CloudRun API (Python)

**Specs iniciais:**
- CPU: 2 vCPU (LLM precisa mais)
- RAM: 2GB
- Instances: 0-5
- Concurrency: 10 (LLM √© CPU-intensive)

**Cen√°rio conservador:**
- Requests: ~200k/m√™s (menos que BFF, pois BFF filtra)
- CPU time: ~100h/m√™s (LLM √© pesado)
- RAM: ~200 GB-hours/m√™s

**Custo:**
- CPU: 100h √ó 2 vCPU √ó $0.00002400 = ~$17.28
- RAM: 200 GB-h √ó $0.00000250 = ~$1.80
- Requests: 200k √ó $0.40/milh√£o = ~$0.08
- **Total: ~$20/m√™s**

#### 3. VPC Connector (Serverless)

**IMPORTANTE:** Sim, voc√™ precisa!

**Fun√ß√£o:** Permite CloudRun BFF (p√∫blico) ‚Üí CloudRun API (privado)

**Specs:**
- Throughput: 200-300 Mbps (m√≠nimo)
- Inst√¢ncias: 2 m√≠nimo (HA)

**Custo:**
- 2 inst√¢ncias e2-micro √ó 730h/m√™s
- ~$13-15/m√™s

**Alternativa:** VPC Access Connector (managed)
- ~$0.072/hora por conector
- ~$52/m√™s (mais caro, mas zero manuten√ß√£o)

**Recomenda√ß√£o:** Use Serverless VPC Access Connector
- Menos ops
- Escala autom√°tico
- Worth it pelo seu perfil (menos ops > custo)

#### 4. CloudSQL (Postgres)

**J√° tem rodando:**
- db-f1-micro ou db-g1-small
- ~$7-15/m√™s (assumindo setup atual)

**SEM custo adicional nesse cen√°rio**

#### 5. Load Balancer (Opcional)

**Se usar:**
- Forwarding rule: ~$18/m√™s
- Data processed: ~$0.008/GB
  - Ex: 100GB/m√™s = $0.80
- **Total: ~$20-25/m√™s**

**Se N√ÉO usar:**
- $0

#### 6. Networking (Egress)

**VPC ‚Üí CloudRun API:**
- Tr√°fego interno na mesma regi√£o: $0
- **Total: $0**

**CloudRun ‚Üí Internet (ex: OpenAI API):**
- Premium tier: $0.12/GB
- Ex: 10GB/m√™s (LLM calls) = $1.20
- **Total: ~$1-5/m√™s**

---

### RESUMO DE CUSTOS (Mensal)

| Componente | Custo (Cen√°rio MVP) |
|------------|---------------------|
| CloudRun BFF (NextJS) | ~$5 |
| CloudRun API (Python) | ~$20 |
| VPC Connector | ~$15 |
| CloudSQL (j√° existe) | ~$10 |
| Load Balancer (opcional) | $0 ou ~$25 |
| Networking/Egress | ~$2 |
| **TOTAL SEM LB** | **~$52/m√™s** |
| **TOTAL COM LB** | **~$77/m√™s** |

**Observa√ß√µes:**
- Custos LLM (OpenAI, etc.) **N√ÉO** inclusos
- Assumindo tr√°fego baixo (MVP)
- Com 1000 usu√°rios/dia, multiply por ~3-5x

---

## Comparativo: 2 CloudRun vs 1 CloudRun Monolito

### Cen√°rio Alternativo: 1 CloudRun (Python monolito)

**Stack:** Python/FastAPI serve tudo (API + static frontend Vite)

**Custo:**
- CloudRun √∫nico: ~$15-25/m√™s
- CloudSQL: ~$10/m√™s
- Frontend em GCS + CDN: ~$1-5/m√™s
- **Total: ~$30-40/m√™s**

**Economia:** ~$12-37/m√™s vs NextJS separado

**Trade-off:**
- ‚úÖ Mais barato
- ‚úÖ Mais simples (1 deploy)
- ‚úÖ Sem VPC Connector
- ‚ùå Sem SSR/SSG do NextJS
- ‚ùå Frontend build separado

---

## Decis√µes Pr√°ticas

### Para seu contexto (MVP em 2 meses):

**Se for de NextJS BFF + Python API separado:**

1. **Infraestrutura Inicial (MVP):**
   ```
   ‚úÖ 2 CloudRun (BFF p√∫blico + API privada)
   ‚úÖ VPC Connector (Serverless)
   ‚úÖ CloudSQL (j√° tem)
   ‚ùå Load Balancer (adia pro futuro)
   ‚ùå Cloud Armor (adia pro futuro)
   ```

2. **Setup do CloudRun API (privado):**
   ```bash
   gcloud run deploy api-python \
     --source . \
     --region us-central1 \
     --ingress internal \              # PRIVADO!
     --vpc-connector vpc-connector-1 \
     --allow-unauthenticated           # Mas s√≥ via VPC
   ```

3. **Setup do CloudRun BFF (p√∫blico):**
   ```bash
   gcloud run deploy bff-nextjs \
     --source . \
     --region us-central1 \
     --ingress all \                    # P√öBLICO
     --vpc-connector vpc-connector-1 \  # Para chamar API
     --set-env-vars="API_URL=https://api-python-xyz.a.run.app"
   ```

4. **VPC Connector:**
   ```bash
   gcloud compute networks vpc-access connectors create vpc-connector-1 \
     --region us-central1 \
     --range 10.8.0.0/28 \              # IP range privado
     --min-instances 2 \
     --max-instances 10
   ```

5. **Custom Domain (BFF):**
   ```bash
   gcloud run domain-mappings create \
     --service bff-nextjs \
     --domain app.pilotodevendas.com.br \
     --region us-central1
   ```

### Custo Final Esperado (MVP):

**M√™s 1-3 (baixo tr√°fego):** ~$50-60/m√™s

**M√™s 4-6 (100-500 usu√°rios):** ~$80-150/m√™s

**Observa√ß√£o:** Ainda √© barato! CloudRun escala muito bem.

---

## Vantagens vs Desvantagens dessa Arquitetura

### ‚úÖ Vantagens

1. **Seguran√ßa:** API n√£o exposta publicamente
2. **Separa√ß√£o de concerns:** BFF cuida de auth, API de business logic
3. **Escalabilidade independente:** BFF e API escalam separadamente
4. **NextJS perks:** SSR, SSG, otimiza√ß√µes autom√°ticas
5. **Zero downtime:** Deploy independente

### ‚ùå Desvantagens

1. **Mais complexidade:** 2 deploys, 2 repos (ou monorepo)
2. **Custo maior:** ~$20-30/m√™s a mais que monolito
3. **VPC Connector obrigat√≥rio:** Adiciona custo e configura√ß√£o
4. **Lat√™ncia adicional:** BFF ‚Üí API (mas m√≠nima na mesma regi√£o)
5. **Curva de aprendizado:** NextJS (voc√™ tem expertise baixo)

---

## Recomenda√ß√£o para o SEU Contexto

### Considerando:
- ‚è±Ô∏è MVP em 2 meses
- üë®‚Äçüíª 1 dev (voc√™), expertise alto Python, b√°sico Node/TS
- üéØ KISS
- üí∞ Prefere gastar mais em infra para menos ops

### Veredicto:

**NextJS BFF separado N√ÉO vale a pena no seu caso.**

**Por qu√™?**

1. **Complexidade vs benef√≠cio:**
   - Voc√™ n√£o precisa de SSR/SEO (√© dashboard)
   - Aumenta infra (~$20-30/m√™s) sem ganho direto

2. **Expertise:**
   - B√°sico em Node/TS ‚Üí vai desacelerar
   - Python voc√™ domina ‚Üí mais produtivo

3. **Timeline:**
   - 2 meses √© apertado
   - 2 stacks = 2√ó trabalho

**Melhor op√ß√£o:** Python + Vite (pr√≥xima se√ß√£o)
- 1 CloudRun (monolito ou BFF Python)
- Frontend Vite em GCS ou servido pelo Python
- Custo: ~$30-40/m√™s
- Complexidade: muito menor
- Expertise: aproveita seu forte (Python)

---

## Mas se AINDA ASSIM quiser NextJS BFF...

### Quando faria sentido:

1. **Voc√™ contratar um dev NextJS** (ou o Jr dominar TS)
2. **Precisar de SSR/SSG** (mudan√ßa de escopo)
3. **BFF complexo** (m√∫ltiplos backends, orquestra√ß√µes)
4. **Time crescer** (2-3 devs, especializa√ß√£o)

### Ent√£o sim:

**Use a arquitetura descrita:**
- 2 CloudRun + VPC Connector
- Comece sem LB, adicione depois
- Custo: ~$50-80/m√™s (MVP)
- Preparado para escalar

---

## Terraform Example (B√¥nus)

```hcl
# VPC Connector
resource "google_vpc_access_connector" "connector" {
  name          = "vpc-connector-1"
  region        = "us-central1"
  ip_cidr_range = "10.8.0.0/28"
  network       = "default"
}

# CloudRun API (Privado)
resource "google_cloud_run_service" "api" {
  name     = "api-python"
  location = "us-central1"

  template {
    spec {
      containers {
        image = "gcr.io/PROJECT/api-python:latest"
        resources {
          limits = {
            cpu    = "2"
            memory = "2Gi"
          }
        }
      }
    }

    metadata {
      annotations = {
        "run.googleapis.com/vpc-access-connector" = google_vpc_access_connector.connector.name
        "run.googleapis.com/vpc-access-egress"    = "private-ranges-only"
      }
    }
  }

  traffic {
    percent         = 100
    latest_revision = true
  }
}

# IAM: Privado (s√≥ interno)
resource "google_cloud_run_service_iam_member" "api_internal" {
  service  = google_cloud_run_service.api.name
  location = google_cloud_run_service.api.location
  role     = "roles/run.invoker"
  member   = "allUsers"  # Mas ingress √© internal-only
}

# CloudRun BFF (P√∫blico)
resource "google_cloud_run_service" "bff" {
  name     = "bff-nextjs"
  location = "us-central1"

  template {
    spec {
      containers {
        image = "gcr.io/PROJECT/bff-nextjs:latest"
        env {
          name  = "API_URL"
          value = google_cloud_run_service.api.status[0].url
        }
      }
    }

    metadata {
      annotations = {
        "run.googleapis.com/vpc-access-connector" = google_vpc_access_connector.connector.name
      }
    }
  }
}

# IAM: P√∫blico
resource "google_cloud_run_service_iam_member" "bff_public" {
  service  = google_cloud_run_service.bff.name
  location = google_cloud_run_service.bff.location
  role     = "roles/run.invoker"
  member   = "allUsers"
}
```

---

## Bottom Line

### Infra NextJS BFF + Python API:

**Arquitetura:** 2 CloudRun + VPC Connector (+ Load Balancer opcional)

**Custo:** ~$50-80/m√™s (MVP)

**Complexidade:** M√©dia-alta

**Vale a pena para voc√™?** Provavelmente **N√ÉO**, pelos motivos citados.

**Pr√≥ximo passo:** Analisar "Python + Vite" (recomendado para seu caso).
